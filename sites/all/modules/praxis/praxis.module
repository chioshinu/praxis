<?php
/**
 * Create doctor biography
 *
 * @param $edit
 * @param $account
 * @param $category
 */
function praxis_user_insert(&$edit, $account, $category) {
    if (isset($account->roles[4])){
        $bio = entity_create('node', array('type' => 'doctor_biography', 'uid' => $account->uid, 'language' => 'en'));
        $ewrapper = entity_metadata_wrapper('node', $bio);
        $ewrapper->field_email->set($account->mail);
        $ewrapper->save(true);
        entity_save('node', $bio);
    }
}

function praxis_user_update(&$edit, $account, $category) {

}

/**
 * Implements hook_block_info().
 *
 * This hook declares what blocks are provided by the module.
 */
function praxis_block_info() {
    $blocks['home_doctors'] = array(
        'info' => t('Home doctors')
    );

    return $blocks;
}

/**
 * Implements hook_block_view().
 *
 * This hook generates the contents of the blocks themselves.
 */
function praxis_block_view($delta = '') {
    // The $delta parameter tells us which block is being requested.
    switch ($delta) {
        case 'home_doctors':
            // The subject is displayed at the top of the block. Note that it
            // should be passed through t() for translation. The title configured
            // for the block using Drupal UI supercedes this one.
            $block['subject'] = t('Willkommen in der 24h Praxis am Bahnhof Ruti, die Praxis fur allgemeine Medizin und Spezialgebiete');
            // The content of the block is typically generated by calling a custom
            // function.
            $block['content'] = praxis_home_doctors_contents($delta);
            break;
    }
    return $block;
}

function praxis_home_doctors_contents(){
    global $language;
    $nodes = node_load_multiple(array(), array('type' => 'doctor_biography'));
//    debug($nodes);
    $data = array();
    foreach($nodes as $bio){
        $data[] = array(
            'name' => $bio->title_field,
            'img' => isset($bio->field_ph['und']) ? $bio->field_ph['und'][0]['uri'] : '',
            'uid' => $bio->uid,
            'nid' => $bio->nid,
            'node' => $bio
        );
    }
    $html = "";

    foreach ($data as $value){
        $img = array(
            'style_name' => 'thumbnail',
            'path' => $value['img'],
            'width' => '',
            'height' => '',
        );
        $title = field_view_field('node', $value['node'], 'title_field', array(), $language->language);
//        debug($title, $value['nid']);
        $html .= '<li>'.theme('image_style', $img).'<span>'.drupal_render($title).'</span></li>';
    }
    return "<ul>{$html}</ul>";
}