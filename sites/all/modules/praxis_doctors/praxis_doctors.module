<?php
/**
 * Create doctor biography
 *
 * @param $edit
 * @param $account
 * @param $category
 */
function praxis_doctors_user_insert(&$edit, $account, $category) {
    if (isset($account->roles[4])){
        $bio = entity_create('node', array('type' => 'doctor_biography', 'uid' => $account->uid, 'status' => 0, 'language' => 'en'));
        $ewrapper = entity_metadata_wrapper('node', $bio);
        $ewrapper->field_email->set($account->mail);
        $ewrapper->save(true);
        entity_save('node', $bio);
//        user_save($account);
//        drupal_goto('node/'.$bio->nid.'/edit');
    }
}

function praxis_doctors_user_login(&$edit, $account){
//    if ($account->access == "0" and isset($account->roles[4])){
    if (isset($account->roles[4])){
        $nodes = node_load_multiple(array(), array('type' => 'doctor_biography', 'uid' => $account->uid));
        if (count($nodes)>0)
        {
            $node = array_shift($nodes);
            $edit['redirect'] = 'node/'.$node->nid.'/edit';
        }
    }
}

function praxis_doctors_form_alter(&$form, &$form_state, $form_id){
    global $user;
    if ($form_id == 'doctor_biography_node_form' and isset($user->roles[4])){
        $form['actions']['submit']['#submit'][] = 'praxis_doctor_biografy_form_submit_alter';
    }
}

function praxis_doctor_biografy_form_submit_alter($form, &$form_state){
    global $language;
    $part = $language->language == 'en' ? '' : '/'.$language->language;
    $form_state['redirect'] = 'team/doctors/'.$form['nid']['#value'];
}

function praxis_doctors_menu() {
    $items['team/doctors'] = array(
        'page callback' => 'team_view',
        'page arguments' => array(1),
        'access arguments' => array('access content'),
        'file' => 'pages.inc'
    );
    $items['team/therapists'] = array(
        'page callback' => 'team_view',
        'page arguments' => array(1),
        'access arguments' => array('access content'),
        'file' => 'pages.inc'
    );
    $items['team/staff'] = array(
        'page callback' => 'team_view',
        'page arguments' => array(1),
        'access arguments' => array('access content'),
        'file' => 'pages.inc'
    );
    $items['team/doctors/%'] = array(
        'page callback' => 'doctor_view',
        'page arguments' => array(2),
        'access arguments' => array('access content'),
        'file' => 'pages.inc'
    );
    return $items;
}

function praxis_doctors_user_update(&$edit, $account, $category) {

}

/**
 * Implements hook_block_info().
 *
 * This hook declares what blocks are provided by the module.
 */
function praxis_doctors_block_info() {
    $blocks['home_doctors'] = array(
        'info' => t('Home doctors')
    );
    $blocks['specializations'] = array(
        'info' => t('Specialties Block')
    );
    $blocks['home_specializations'] = array(
        'info' => t('Home page Specialties Block')
    );
    return $blocks;
}

/**
 * Implements hook_block_view().
 *
 * This hook generates the contents of the blocks themselves.
 */
function praxis_doctors_block_view($delta = '') {
    // The $delta parameter tells us which block is being requested.
    switch ($delta) {
        case 'home_doctors':
            // The subject is displayed at the top of the block. Note that it
            // should be passed through t() for translation. The title configured
            // for the block using Drupal UI supercedes this one.
            $block['subject'] = t('Willkommen in der 24h Praxis am Bahnhof Ruti, die Praxis fur allgemeine Medizin und Spezialgebiete');
            // The content of the block is typically generated by calling a custom
            // function.
            $block['content'] = praxis_doctors_home_doctors_contents($delta);
            break;
        case 'specializations':
            $block['content'] = praxis_doctors_block_specializations();
            break;
        case 'home_specializations':
            $block['content'] = praxis_doctors_block_specializations();
            break;
    }
    return $block;
}

function praxis_doctors_home_doctors_contents(){
    global $language;
    $nodes = node_load_multiple(array(), array('type' => 'doctor_biography', 'status' => 1));
//    debug($nodes);
    $data = array();
    $i = 0;
    foreach($nodes as $bio){
        if ($i == 0){
            $slide = array();
        }
        $slide[] = $bio;
        if ($i == 9){
            $data[] = $slide;
            $i = 0;
        }
        else{
            $i++;
        }
    }
    if ($i<9 && count($slide) >0){
        $data[] = $slide;
    }

    drupal_add_js(drupal_get_path('module', 'praxis_doctors') . '/js/jquery.slides.js');
    $build['myelement'] = array(
        '#theme' => 'doctors_block',
        '#doctors' => $data,
    );
    $output = theme('doctors_home_block', array('doctors' => $data, 'lang' => $language->language));
    return $output;
}

function praxis_doctors_block_specializations(){
    global $language;
    $terms = i18n_taxonomy_localize_terms(taxonomy_get_tree(2, 0, null, true));
    return theme('specialization_block', array('terms' => $terms, 'lang' => $language->language));

}

function praxis_doctors_theme() {
    global $language;
    return array(
        'doctors_home_block' => array(
            'template' => 'doctors',
            'variables' => array('doctors' => array(), 'lang' => $language->language),
        ),
        'doctors_page' => array(
            'template' => 'doctors_page',
            'variables' => array('data' => array(), 'terms' => array(), 'lang' => $language->language),
        ),
        'specialization_block' => array(
            'template' => 'specialization_block',
            'variables' => array('terms' => array(), 'lang' => $language->language),
        ),
        'single_doctor_page' => array(
            'template' => 'single_doctor_page',
            'variables' => array('doctor' => array(), 'pages' => array(), 'lang' => $language->language, 'user' => null),
        ),
    );
}

function slug($str){
    return str_replace(' ', '_',str_replace('/', '', strtolower($str)));
}